#!/bin/bash

set -e

OUTPUT_JS="a.out.js"

i=1
while [ "$i" -le "$#" ]; do
  eval "arg=\${$i}"
  if [[ $arg == "-o" ]]; then
    i=$((i + 1))
    eval "OUTPATH=\${$i}"
    OUTFILE=$(basename $OUTPATH)
    if [[ $OUTFILE == *.html || $OUTFILE == *.js ]]; then
      OUTPUT_JS=$(dirname $OUTPATH)/${OUTFILE%*.*}.js
    else
      echo "Please specify either an HTML or JavaScript output." && exit -1
    fi
    break
  fi
  i=$((i + 1))
done

SRC_DIR="$( cd "$( dirname "$0" )" && pwd )"
FS_DIR=$SRC_DIR/fs

$SRC_DIR/generate-pre.sh

emcc $* \
    --js-library $FS_DIR/library_cvmfs.js \
    --js-library $FS_DIR/library_fs.js \
    --pre-js $SRC_DIR/pre.js

OUTPUT_JS_TMP=$OUTPUT_JS.tmp
cat $SRC_DIR/third_party/sql.js > $OUTPUT_JS_TMP
cat $OUTPUT_JS >> $OUTPUT_JS_TMP
mv $OUTPUT_JS_TMP $OUTPUT_JS